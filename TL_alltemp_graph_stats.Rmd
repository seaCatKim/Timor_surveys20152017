---
title: "Timoe-Leste 2015-2017 temperature data"
author: "Catherine Kim"
date: "December 16, 2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
```

## Current paper results

## Timor-Leste in situ and satellite temperature data from Nov 2015 to Jul 2017
Monthly average of daily maximum temperature from 'graph-CKTLtemp-allsitesdepth.RMD'
```{r combine  sites 5 and 10 m depth montly mean from daily max, crw data}
temp <- read_csv("data/alltemp_TL.csv") %>% 
   mutate_if(is.character, as.factor)
head(temp)

temp$m.y <- as.factor(temp$m.y)
temp$month <- as.factor(temp$month)
temp$year <- as.factor(temp$year)
temp$Depth <- as.factor(temp$Depth)
temp$Depth <- relevel(temp$Depth, ref = '5m')

# relevel month/yr in correct order
levels(temp$m.y)
temp$m.y = factor(temp$m.y,levels(temp$m.y)[c(21,24,3,5,7,1,9,11,13,15,17,19,22,25,4,6,8,2,10,12,14,16,18,20,23)])
```
```{r boxplot monthly temp ave by site}
ggplot(temp, aes(x = Site, y = Temp, fill = year)) +
   facet_grid(Depth~.)+
    geom_boxplot() +
   geom_point(aes(color = year), position = position_jitter(0.21)) +
    theme_classic()
```
Incorrect SE values for ANOVA stats - using the SE values from calculating the monthly averages...
No replication at site/depth, only one logger per site/depth and only one satellite 
satellite data is repeated per depth

would commenting out the geom_ribbon line be the accurate representation of the data in the ANOVA?
OR is it ok to include the error ribbon as long as it is clear its from the montly average calculation of the data?
```{r line graph all sites by month/yr}
cbPalette <- c("#D55E00", "#56B4E9", "#009E73",  "#CC79A7")

ggplot(temp, aes(m.y, Temp, group = Site, color = Site)) + facet_grid(Depth~.) +
   geom_ribbon(aes(ymax=Temp+(2*se), ymin=Temp-(2*se), fill = Site), alpha = 0.4) +
   geom_line()+
   scale_color_manual( values = cbPalette) +
   scale_fill_manual(values = cbPalette) +
   theme_classic() +
   ggtitle("Coral Reef Watch - In Situ Temperature Monthly Mean + 2SE") +
   xlab("Month/Year") + ylab("Temperature [C]") +
   theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
      geom_hline(yintercept = 29.5, color = "light blue", linetype = 2) +
   geom_hline(yintercept = 30.5, color = "light blue") 
#ggsave('figures/line_TLtemp.pdf', width = 7, height = 4)
```

Assigning the austral season to each month 1-3 = summer etc.
```{r filter overlapping Crw and c data, add season, add method}
season <- data.frame(month = 1:12, season = rep(c("summer", "fall", "winter", "spring"), each = 3))
season$month <- as.factor(season$month)
season

method <- data.frame(Site = c("Rural-N", "Urban-E", "Urban-W", "CRWTL"), Method = c("insitu", "insitu", "insitu", "sat"))
method

# subset out data with both CRW and logger temperature data
temp.same <- temp %>% filter(m.y != "8/2015" & m.y != "9/2015" & m.y != "10/2015" & m.y != "11/2015" & 
                                m.y != "6/2017" & m.y != "7/2017" & m.y != "8/2017") %>% 
  inner_join(season, by = 'month') %>% 
   inner_join(method, by = 'Site')

# remove CRW for one depth used for plot
temp.same <- temp.same[-which(temp.same$Site == 'CRWTL' & temp.same$Depth == '10m'),] #

# relevel method so sat is reference
temp.same$Method <- relevel(temp.same$Method, ref = "sat")

head(temp.same)

# only crw from temp same
crw.same <- filter(temp.same, Site == 'CRWTL') %>% 
   select(Site, m.y, Temp, sd, se, N)

colnames(crw.same)[which(colnames(crw.same) == 'Temp')] <- 'siteave'

#write.csv(temp.same, 'TL_CRW_logger_alltempsame.csv')
```

## Graph without facet by depth
average the 2 loggers per site
1 satellitepoint per month

```{r ave temp loggers by site}
temp.avelog <- temp.same %>% 
   filter(Site != 'CRWTL') %>% 
   group_by(Site, m.y) %>% 
   dplyr::summarise(siteave = mean(Temp), sd = sd(Temp), se = sd/sqrt(n()), N = n())

temp.avelog

# comgine crw montly ave se and logger by site ave and se
temp.avelog.crw <- rbind.data.frame(temp.avelog, crw.same )
```

Plotting satellite monthly average without error and 2 loggers averages per site with SE
```{r line graph all sites by month/yr no depth facet}
ggplot(data = temp.avelog.crw, aes(m.y, siteave, group = Site, color = Site)) +
   geom_line( aes(m.y, siteave, group = Site, color = Site)) + 
   geom_ribbon( aes(ymax= siteave+(se), ymin= siteave-(se), fill = Site), alpha = 0.4) +
   geom_line()+
   scale_color_manual( values = cbPalette, name = 'Site/Method') +
   scale_fill_manual(values = cbPalette, name = 'Site/Method') +
   theme_classic() +
   #ggtitle("Coral Reef Watch - In Situ Temperature Monthly Mean + SE") +
   xlab("Month/Year") + ylab("Temperature [C]") +
   theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
         axis.text = element_text(size = 12),
         axis.title = element_text(size = 16),
         legend.text = element_text(size = 12),
         legend.title = element_text(size = 14)) +
      geom_hline(yintercept = 29.5, color = "light blue", linetype = 2) +
   geom_hline(yintercept = 30.5, color = "light blue") 
ggsave('figures/line_TLtemp.pdf', width = 7, height = 4)
```
## Statistics
```{r histograph Temp, anova}
hist(temp.same$Temp)
```

## Statistics testing site/depth differences between logger data
```{r remove satellite data for only logger data}
logger <- filter(temp.same, temp.same$Method != 'sat') %>% droplevels()
head(logger)
```

If I only have one logger per site and depth - can i test the variance between site and depth across month/year?
```{r Anova on logger temperature differences between site, depth, month/year}
log.lm <- lm(Temp~Site*Depth + factor(month)/factor(year), data = logger)
library(car)
Anova(log.lm)
plot(log.lm)

library(emmeans)
emmeans(log.lm, list(pairwise ~ factor(month):factor(year)), adjust = "tukey")
emmeans(log.lm, list(pairwise ~ Site:Depth), adjust = "tukey")

boxplot(Temp~Depth, data = logger)
boxplot(Temp~Site, data = logger)
boxplot(Temp~Site:Depth, data = logger, las = 2)
boxplot(Temp~month, data = logger)

logger$Ym <- interaction(logger$year, logger$month)
boxplot(Temp~Ym, data = logger, las = 2)
```

```{r test autocorrelation of loggers}
library(DHARMa)

res = simulateResiduals(log.lm)
res = recalculateResiduals(res, group = logger$m.y)

testTemporalAutocorrelation(res, time = unique(logger$m.y))
```

10 m loggers warmer thatn 5 m loggers which is unexpected, shallowers loggers should be warmer closer to the surface/sun
could be submarine groundwater discharge? or logger error over time
```{r box plot showing site:depth interaction}
ggplot(logger, aes(Depth, Temp)) + facet_grid(.~Site)+
   geom_jitter(aes(color = Depth)) +
   geom_boxplot(fill = NA) + 
   theme_classic()
```
The El nino during 2016 was significantly warmer than corresponding months in 2015 and 2017
```{r box plot showing month/year interaction}
ggplot(logger, aes(year, Temp)) + facet_grid(.~month) +
   geom_jitter(aes(color = year)) +
   geom_boxplot(fill = NA) + 
   theme_classic()
```
with no depth - only month/year is significant
```{r Anova on logger temperature differences between site, month/year}
log.lm.nodepth <- lm(Temp~Site + factor(month)/factor(year), data = logger)
Anova(log.lm.nodepth)
plot(log.lm.nodepth)

emmeans(log.lm.nodepth, list(pairwise ~ factor(month):factor(year)), adjust = "tukey")
emmeans(log.lm.nodepth, list(pairwise ~ Site), adjust = "tukey")

boxplot(Temp~Site, data = logger)
boxplot(Temp~month, data = logger)

logger$Ym <- interaction(logger$year, logger$month)
boxplot(Temp~Ym, data = logger, las = 2)
```

```{r }
sitedepth.ave <- logger %>% 
   group_by(Site,Depth) %>% 
   dplyr::summarize(ave = mean(Temp), SD = sd(Temp), se = SD/sqrt(n()))
sitedepth.ave

logger %>% 
   group_by(month, year) %>% 
   summarize(ave = mean(Temp), SD = sd(Temp), se = SD/sqrt(n()))
```
```{r ave diff betwen site ave temp 5 vs 10 m}
sitedepth.diff <- sitedepth.ave %>% 
   select(Site, Depth, ave) %>% 
   spread(Depth, ave) %>% 
   mutate(diff = `10m` - `5m`)
sitedepth.diff
ave(sitedepth.diff$diff)
```

## Statistics testing site(3 logger sites and satellite) by season
```{r site by season anova}
site.lm <- lm(Temp~Site * season, data = temp.same)
library(car)
Anova(site.lm)
library(emmeans)
emmeans(site.lm, list(pairwise ~ season), adjust = "tukey")
emmeans(site.lm, list(pairwise ~ Site), adjust = "tukey")

boxplot(Temp~Site, data = temp.same)
boxplot(Temp~season, data = temp.same)
```
```{r type III anova site by season}
site.lm2 <- lm(Temp~Site * season, data = temp.same, contrasts = list(Method = contr.sum, season = contr.sum))
library(car)
Anova(site.lm2, type = 'III')
library(emmeans)
emmeans(site.lm2, list(pairwise ~ season), adjust = "tukey")
emmeans(site.lm2, list(pairwise ~ Site), adjust = "tukey")

boxplot(Temp~Site, data = temp.same)
boxplot(Temp~season, data = temp.same)
#same result as type II anova
```

```{r boxplot showing method:season interaction}
ggplot(temp.same, aes(season, Temp)) + 
   geom_jitter() +
   geom_boxplot(fill = NA) + 
   theme_classic()

ggplot(temp.same, aes(Site, Temp)) + 
   geom_jitter() +
   geom_boxplot(fill = NA) + 
   theme_classic()
```

testing method (logger or satellite) by season
```{r method by season anova}
method.lm <- lm(Temp~Method*season, data = temp.same)
Anova(method.lm)

emmeans(method.lm, list(pairwise ~ season), adjust = "tukey")
emmeans(method.lm, list(pairwise ~ Method), adjust = "tukey")
emmeans(method.lm, list(pairwise ~ Method:season), adjust = "tukey")

boxplot(Temp~Method, data = temp.same)
boxplot(Temp~season, data = temp.same)
boxplot(Temp~Method:season, data = temp.same, las = 2)
```

ANOVA with type III sums of sqs folloing https://www.r-bloggers.com/2011/03/anova-%E2%80%93-type-iiiiii-ss-explained/
```{r Type III SS method by season anova}
method.lm <- lm(Temp~Method*season, data = temp.same, contrasts = list(Method = contr.sum, season = contr.sum))
Anova(method.lm, type = 'III')

emmeans(method.lm, list(pairwise ~ season), adjust = "tukey")
emmeans(method.lm, list(pairwise ~ Method), adjust = "tukey")
emmeans(method.lm, list(pairwise ~ Method:season), adjust = "tukey")

boxplot(Temp~Method, data = temp.same)
boxplot(Temp~season, data = temp.same)
boxplot(Temp~Method:season, data = temp.same, las = 2)
```
```{r test autocorrelation for CRW and loggers by method}
res = simulateResiduals(method.lm)
res = recalculateResiduals(res, group = temp.same$m.y)

testTemporalAutocorrelation(res, time = unique(temp.same$m.y))
```
```{r box plot showing method:season interaction}
ggplot(temp.same, aes(Method, Temp)) + facet_grid(.~season) +
   geom_jitter(aes(color = Method)) +
   geom_boxplot(fill = NA) + 
   theme_classic()
```
```{r ave temp by CRW and all loggers together}
temp.same %>% 
   group_by(Method, season) %>% 
   summarize(avetemp = mean(Temp), SDtemp = sd(Temp), SEtemp = sd(Temp)/sqrt(n()))
```

