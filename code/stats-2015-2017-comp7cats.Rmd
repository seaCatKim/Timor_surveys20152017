---
title: "Statistics on 2015-2017 coral health data from Timor-Leste"
author: "Catherine Kim"
date: "`r Sys.time()"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## read in transect data with comp7 cats inc white syndrome (WS) and growth anomalies (GAs)

```{r read in data with growth anomaolies (GAs) separated }
compd.t <- read.csv(here::here('data/comp8GA_tave.csv'))
head(compd.t)
```

```{r create unique transect id}
compd.t$long_id <- as.factor(paste(compd.t$Site, compd.t$Depth, compd.t$Transect, sep = "_"))

#write.csv(levels(compd.t$id), "unique_ids.csv")
# write levels and add num id
# read file with num id
ids <- read.csv(here::here("data/unique_ids_wnum.csv"))

library(dplyr)
compd.t <- inner_join(compd.t, ids, by = 'long_id') # join unique transect ids
   # change num_id an year to factors
compd.t$num_id <- as.factor(compd.t$num_id)
compd.t$Year <- as.factor(compd.t$Year)

levels(compd.t$Site)

head(compd.t)
```

## summary stats

```{r total disease ave by site and depth}
library(Rmisc)
library(tidyr)
library(dplyr)

# ave disease across years at site and depth
compd.t %>% 
   mutate(disease = WS + GA) %>%
   group_by(Site, Depth ) %>% 
   dplyr::summarize(dave = mean(disease),
             SE = sd(disease)/sqrt(n()))


hist(compd.t$WS + compd.t$GA)

# proportion of disease at Rural-N
compd.t %>% 
   dplyr::mutate(disease = WS + GA)%>% 
   dplyr::summarize(sum(disease))

compd.t %>% 
   dplyr::mutate(disease = WS + GA)%>% 
   filter(Site == 'Beloi') %>% 
   dplyr::summarize(sum(disease))

12.04151	/ 26.84603	
```

```{r prevalence WS and GAs by year}
ws.ga.yr <- compd.t %>% 
   group_by( Year) %>% 
   dplyr::summarize(WSave = mean(WS), WSSE = sd(WS)/sqrt(n()),
             GAave = mean(GA), GASE = sd(GA)/sqrt(n()))
ws.ga.yr
```
```{r prevalence WS and GAs by site and year}
ws.ga.styr <- compd.t %>% 
   group_by(Site, Year) %>%  
   dplyr::summarize(WSave = mean(WS), WSSE = sd(WS)/sqrt(n()),
             GAave = mean(GA), GASE = sd(GA)/sqrt(n()))
ws.ga.styr
```

```{r ave comp health }
# across sites, depth, and years
compave <- compd.t %>% 
   mutate(comp = CCA + BL + AllAlgae + TL + OTH + GA) %>% 
   group_by(Site, Depth, Transect, Year) %>% 
   dplyr::summarize(totcomp = sum(comp))%>%
   ungroup()%>% 
   group_by(Site, Depth) %>% 
   dplyr::summarize(cave = mean(totcomp),
             Se = sd(totcomp)/sqrt(n()))
compave

# across site and depth, ave across years
compd.t %>% 
   mutate(comp = CCA + BL + AllAlgae + TL + OTH) %>% 
   group_by(Site, Depth) %>% 
   dplyr::summarize(avecomp = mean(comp), SE = sd(comp)/sqrt(n()))

# overall compromised health average
mean(compave$cave)
sd(compave$cave)/sqrt(length(compave))
```

```{r ave disease and comp health by site year}
cd <- compd.t %>% 
   dplyr::mutate(compd = CCA + BL + AllAlgae + TL + OTH + GA + WS) %>% 
   group_by(Site,Year) %>% 
   dplyr::summarize(avecd = mean(compd),
             SE = sd(compd)/sqrt(n()))
cd
```


```{r ave all algae growth per site}
alg <- compd.t %>% 
   group_by(Site, Year) %>% 
   dplyr::summarize(avealg = mean(AllAlgae),
             SE = sd(AllAlgae)/sqrt(n()))
alg
```

```{r check}
compd.tl <- gather(compd.t, Status, Percent, CCA, BL, AllAlgae, TL, OTH, WS, Healthy, GA)
head(compd.tl)

hist(compd.tl$Percent)
hist(sqrt(compd.tl$Percent))
```

## ANOVAS of compromised health categories 

```{r bleaching hist and plot}
hist(compd.t$BL)
qqnorm(compd.t$BL)
#qqplot(compd.t$BL)

hist(sqrt(compd.t$BL))
qqnorm(sqrt(compd.t$BL))
#qqplot(sqrt(compd.t$BL))

library(car)
leveneTest((BL)~Year*Site*Depth, compd.t)
```

```{r bleaching summary stats and plot}
bl.se <- summarySE(compd.t, "BL", c("Year", "Site", 'Depth'))
bl.se

summarySE(compd.t, "BL", c("Year", "Site"))

library(ggpubr)
ggboxplot(
  data = compd.t, x = "Site", y = "BL", facet.by = 'Depth',
  color = "Year", palette = "jco"
  )
```

# Healthy stats
```{r healthy hist plot}
hist(compd.t$Healthy)
shapiro.test(compd.t$Healthy)

ggboxplot(
  compd.t, x = "Site", y = "Healthy", facet.by = 'Depth',
  color = "Year", palette = "jco"
  )

```
```{r healthy repeated measures}
library(nlme)
h.lme <- lme((Healthy) ~ Year * Site*Depth, random = ~1|num_id, data = compd.t,
             na.action = na.exclude)
h.lme
summary(h.lme)
Anova(h.lme)  
library(emmeans)
emmeans(h.lme, list(pairwise ~ Year), adjust = "tukey")
emmeans(h.lme, list(pairwise ~ Site), adjust = "tukey")
emmeans(h.lme, list(pairwise ~ Depth), adjust = "tukey")

```

```{r summarize healthy by site and year}
library(Rmisc)

comp.h <- summarySE(compd.t, "Healthy", c("Year", "Site", "Depth"))
head(comp.h)

comp.hs <- summarySE(compd.t, "Healthy", c("Site"))
head(comp.hs)

comp.hd <- summarySE(compd.t, "Healthy", c("Depth"))
head(comp.hd)

comp.hyr <- summarySE(compd.t, "Healthy", c("Year"))
head(comp.hyr)

mean(compd.t$Healthy)
sd(compd.t$Healthy)/sqrt(length(compd.t))

comp.ave <- compd.t %>% 
   group_by(Site, Year) %>%
   summarise_all(mean)

bl.ave <- summarySE(compd.t, "BL", c("Year", "Site"))
ws.ave <- summarySE(compd.t, "WS", c("Year", "Site"))
```

# Plot of disease and compromised health states

## combine GAs with OTHER for plot
```{r}
compd.t

compd.t$OTH <-  compd.t$OTH + compd.t$GA
compd.t$GA <- NULL
```

## average categories by site and convert to long format

```{r average disease and compromised health categories by site}
ave_compd <- compd.t %>% 
   pivot_longer(AllAlgae:WS,
                names_to = "Category",
                values_to = "Percent") %>% 
   group_by(Year, Site2, Category) %>% 
      dplyr::summarize(avePer = mean(Percent))

ave_compd
```

## stacked graph without depth facet

```{r average by year and site}
ave_compd$Category <- factor(ave_compd$Category, levels=c("WS", "OTH", "TL", "CCA","AllAlgae", "BL", "Healthy"))

ave_compd
```

```{r no facet by depth}
ggplot(ave_compd, aes((Year), avePer,  fill = Category)) +
   facet_grid(.~Site2, switch = "x") +
    geom_bar(position="stack", stat="identity")+ 
 #  ggtitle("Signs of Compromised Health 2015, 2017") +
   theme_classic() +
labs(x = "", y = "Percent") +
   theme(plot.title = element_text("sans", "bold",color = "black", 15)) +
   theme(text = element_text(size = 16)) +
   theme(axis.ticks.x = element_blank()) + #, panel.background = element_rect("gray85"))+
   theme(axis.text.x = element_text(hjust = 0.5),
         legend.title = element_blank())+
   scale_fill_brewer(palette="RdYlBu")
ggsave(here::here('figures/stacked-comphealth-20152017-nodepth.pdf'), width = 7, height = 4)
```