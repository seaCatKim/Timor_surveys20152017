---
title: "stats-2015-2017 coral health data"
author: "CKim"
date: "September 7, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## read in transect data with comp7 cats inc ws and GAs

```{r read in data with growth anomaolies (GAs) separated }
compd.t <- read.csv(here::here('data/comp8GA_tave.csv'))
head(compd.t)
```
```{r create unique transect id}
compd.t$long_id <- as.factor(paste(compd.t$Site, compd.t$Depth, compd.t$Transect, sep = "_"))

#write.csv(levels(compd.t$id), "unique_ids.csv")
# write levels and add num id
# read file with num id
ids <- read.csv(here::here("data/unique_ids_wnum.csv"))

library(dplyr)
compd.t <- inner_join(compd.t, ids, by = 'long_id') # join unique transect ids
   # change num_id an year to factors
compd.t$num_id <- as.factor(compd.t$num_id)
compd.t$Year <- as.factor(compd.t$Year)

levels(compd.t$Site)

head(compd.t)
```

## summary stats
```{r total disease ave by site and depth}
library(Rmisc)
library(tidyr)
library(dplyr)
dis <- compd.t %>% 
   mutate(disease = WS + GA) %>%
   group_by(Site, Depth ) %>% 
   dplyr::summarize(dave = mean(disease),
             SE = sd(disease)/sqrt(n()))
dis

hist(compd.t$WS + compd.t$GA)

# proportion of disease at Rural-N
compd.t %>% 
   dplyr::mutate(disease = WS + GA)%>% 
   dplyr::summarize(sum(disease))

compd.t %>% 
   dplyr::mutate(disease = WS + GA)%>% 
   filter(Site == 'Beloi') %>% 
   dplyr::summarize(sum(disease))

12.04151	/ 26.84603	
```
```{r prevalence WS and GAs by year}
ws.ga.yr <- compd.t %>% 
   group_by( Year) %>% 
   dplyr::summarize(WSave = mean(WS), WSSE = sd(WS)/sqrt(n()),
             GAave = mean(GA), GASE = sd(GA)/sqrt(n()))
ws.ga.yr
```
```{r prevalence WS and GAs by site and year}
ws.ga.styr <- compd.t %>% 
   group_by(Site, Year) %>%  
   dplyr::summarize(WSave = mean(WS), WSSE = sd(WS)/sqrt(n()),
             GAave = mean(GA), GASE = sd(GA)/sqrt(n()))
ws.ga.styr
```

```{r ave comp health across sites and years}
compave <- compd.t %>% 
   mutate(comp = CCA + BL + AllAlgae + TL + OTH + GA) %>% 
   group_by(Site, Depth, Transect, Year) %>% 
   dplyr::summarize(totcomp = sum(comp))%>%
   ungroup()%>% 
   group_by(Site, Depth) %>% 
   dplyr::summarize(cave = mean(totcomp),
             Se = sd(totcomp)/sqrt(n()))
compave

mean(compave$cave)
sd(compave$cave)/sqrt(length(compave))
```
```{r ave disease and comp health by site year}
cd <- compd.t %>% 
   dplyr::mutate(compd = CCA + BL + AllAlgae + TL + OTH + GA + WS) %>% 
   group_by(Site,Year) %>% 
   dplyr::summarize(avecd = mean(compd),
             SE = sd(compd)/sqrt(n()))
cd
```


```{r ave all algae growth per site}
alg <- compd.t %>% 
   group_by(Site, Year) %>% 
   dplyr::summarize(avealg = mean(AllAlgae),
             SE = sd(AllAlgae)/sqrt(n()))
alg
```

```{r check?}
compd.tl <- gather(compd.t, Status, Percent, CCA, BL, AllAlgae, TL, OTH, WS, Healthy, GA)
head(compd.tl)

hist(compd.tl$Percent)
hist(sqrt(compd.tl$Percent))
```


## anovas ----
```{r bleaching hist and plot}
hist(compd.t$BL)
qqnorm(compd.t$BL)
#qqplot(compd.t$BL)

hist(sqrt(compd.t$BL))
qqnorm(sqrt(compd.t$BL))
#qqplot(sqrt(compd.t$BL))

leveneTest((BL)~Year*Site*Depth, compd.t)
leveneTest((BL)~Year*Site*Depth, trans.comp) # not significant
bl.anE <- aov(sqrt(BL)~Site*Depth + Error(Year), trans.comp)
summary(bl.anE)

bl.an <- aov((BL)~Year*Site*Depth, trans.comp)
summary(bl.an)
TukeyHSD(bl.an)
```
```{r bleaching summary stats and plot}
bl.se <- summarySE(compd.t, "BL", c("Year", "Site", 'Depth'))
bl.se

summarySE(compd.t, "BL", c("Year", "Site"))

ggboxplot(
  data = compd.t, x = "Site", y = "BL", facet.by = 'Depth',
  color = "Year", palette = "jco"
  )
```
```{r bleaching lmer repeated anova}
library(nlme)
bl.lme <- lme(sqrt(BL) ~ Year * Site*Depth, random = ~1|num_id, data = compd.t,
              na.action = na.exclude)
bl.lme
summary(bl.lme)
library(car)
Anova(bl.lme) # year:site:depth interaction
library(emmeans)
bl.tuk <- emmeans(bl.lme, list(pairwise ~ Year:Site:Depth), adjust = "tukey")
bl.tukpair <- as.data.frame(bl.tuk$`pairwise differences of Year, Site, Depth`)

bl.tukpair[which(bl.tukpair$p.value < 0.05),]
```
# algae overgrowth anova
```{r anova algae overgrowth}
hist(compd.t$AllAlgae + compd.t$CCA)
qqnorm(compd.t$AllAlgae + compd.t$CCA)
qqnorm(compd.t$AllAlgae)
leveneTest((AllAlgae)~Year*Site*Depth, trans.comp)
aa.an <- aov(AllAlgae~Year*Site*Depth, trans.comp)
summary(aa.an)
TukeyHSD(aa.an)

ggboxplot(
  data = compd.t, x = "Site", y = "AllAlgae", 
  color = "Year", palette = "jco"
  )

aa.se <- summarySE(compd.t, "AllAlgae", c("Year", "Site"))
aa.se
```
```{r algae lmer repeated anova}
aa.lme <- lme((AllAlgae) ~ Year * Site*Depth, random = ~1|num_id, data = compd.t, na.action = na.exclude)
aa.lme
summary(aa.lme)
Anova(aa.lme)  # Year:site interaction
emmeans(aa.lme, list(pairwise ~ Year:Site), adjust = "tukey")
```
## CCA anovas
```{r CCCA}
hist(compd.t$CCA)

compd.t$slogCCA <- log10((compd.t$CCA * (N-1) + .5)/N)

hist((compd.t$slogCCA))
#qqnorm(log10(compd.t$CCA+1))

qqnorm(sqrt(compd.t$CCA))
leveneTest(sqrt(CCA)~Year*Site*Depth, trans.comp) # not significant
cca.an <- aov(sqrt(CCA)~Year*Site*Depth, trans.comp)
summary(cca.an)
TukeyHSD(cca.an)

cca.se <- summarySE(compd.t, "CCA", c("Year", "Site"))

ggboxplot(
  data = compd.t, x = "Site", y = "CCA", facet.by = 'Depth',
  color = "Year", palette = "jco"
  )
```

```{r CCA lmer repeatd anova}
cca.lme <- lme((CCA) ~ Year * Site*Depth, random = ~1|num_id, data = trans.comp,
             na.action = na.exclude)
cca.lme
summary(cca.lme)
Anova(cca.lme)  # sig year:site, site:depth interactions
emmeans(cca.lme, list(pairwise ~ Year:Site), adjust = "tukey")
emmeans(cca.lme, list(pairwise ~ Site:Depth), adjust = "tukey")
```

## other not included
```{r anova other compromised health}
hist(sqrt(compd.t$OTH))
qqnorm(sqrt(compd.t$OTH))
leveneTest(sqrt(OTH)~Year*Site*Depth, trans.comp)
oth.an <- aov(sqrt(OTH)~Year*Site*Depth, trans.comp)
summary(oth.an)
TukeyHSD(oth.an)
```
```{r anova tissue loss}
hist(compd.t$TL)
#hist(log10(compd.t$TL+1))
hist(sqrt(compd.t$TL))
qqnorm(sqrt(compd.t$TL))
leveneTest((TL)~Year*Site*Depth, trans.comp) # not sig

TL.an <- aov(sqrt(TL)~Year*Site*Depth, trans.comp)
summary(TL.an)

ggboxplot(
  data = compd.t, x = "Site", y = "TL", facet.by = 'Depth',
  color = "Year", palette = "jco"
  )
```
```{r TL lmer repeated anova}
tl.lme <- lme((TL) ~ Year * Site*Depth, random = ~1|num_id, data = trans.comp,
             na.action = na.exclude)
tl.lme
summary(tl.lme)
Anova(tl.lme)  # sig year
emmeans(tl.lme, list(pairwise ~ Year), adjust = "tukey")
```



# Healthy stats
```{r healthy hist plot}
hist(compd.t$Healthy)
shapiro.test(compd.t$Healthy)

ggboxplot(
  compd.t, x = "Site", y = "Healthy", facet.by = 'Depth',
  color = "Year", palette = "jco"
  )
```
```{r healthy repeated measures}
h.lme <- lme((Healthy) ~ Year * Site*Depth, random = ~1|num_id, data = compd.t,
             na.action = na.exclude)
h.lme
summary(h.lme)
Anova(h.lme)  
emmeans(h.lme, list(pairwise ~ Year), adjust = "tukey")
emmeans(h.lme, list(pairwise ~ Site), adjust = "tukey")
emmeans(h.lme, list(pairwise ~ Depth), adjust = "tukey")

```
```{r summarize healthy by site and year}
library(Rmisc)

comp.h <- summarySE(compd.t, "Healthy", c("Year", "Site", "Depth"))
head(comp.h)

comp.hs <- summarySE(compd.t, "Healthy", c("Site"))
head(comp.hs)

comp.hd <- summarySE(compd.t, "Healthy", c("Depth"))
head(comp.hd)

comp.hyr <- summarySE(compd.t, "Healthy", c("Year"))
head(comp.hyr)

mean(compd.t$Healthy)
sd(compd.t$Healthy)/sqrt(length(compd.t))

comp.ave <- compd.t %>% 
   group_by(Site, Year) %>%
   summarise_all(mean)

bl.ave <- summarySE(compd.t, "BL", c("Year", "Site"))
ws.ave <- summarySE(compd.t, "WS", c("Year", "Site"))
```

# WS stats ----
# repeated measures Anova not included in thesis
```{r}
hist(compd.t$WS)
qqnorm(compd.t$WS)
shapiro.test(compd.t$WS)

library(ggpubr)
ggboxplot(
  compd.t, x = "Site", y = "WS", facet.by = 'Depth',
  color = "Year", palette = "jco"
  )

N <- nrow(compd.t)
compd.t$slogWS <- log10((compd.t$WS * (N-1) + .5)/N)
hist(compd.t$slogWS)
qqnorm(log10(compd.t$WS))
qqline(log10(compd.t$WS))
shapiro.test(compd.t$slogWS)

# anova with aov
ws.an <- aov(WS~Year*Site*Depth, data = compd.t)
summary(ws.an)
plot(ws.an)

ws.an2 <- aov(slogWS~Year*Site*Depth, data = compd.t)
summary(ws.an)
plot(ws.an)
```
```{r lmer repeated anova of WS}
ws.lme <- lme(WS ~ Year * Site * Depth, random = ~1|num_id, data = compd.t,
              na.action = na.exclude)
ws.lme
summary(ws.lme) # lowest AIC
Anova(ws.lme)
emmeans(ws.lme, list(pairwise ~ Site), adjust = "tukey")

# lmer with slog
logws.lme <- lme(slogWS ~ Year * Site * Depth, random = ~1|num_id, data = compd.t,
              na.action = na.exclude)
logws.lme
summary(logws.lme) # lowest AIC
Anova(logws.lme)
emmeans(logws.lme, list(pairwise ~ Site), adjust = "tukey")

```

