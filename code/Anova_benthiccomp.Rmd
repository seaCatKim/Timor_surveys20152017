---
title: "Repeated measures anova of hard coral from benthic composition"
author: "CKim"
date: "12/14/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(Rmisc)
library(tidyr)
library(dplyr)
library(ggplot2)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:
```{r }
comp15.l <- read.csv("data/TL2015-BenthicCategories,Site,Depth-long.csv")
comp15.l$X <- NULL
head(comp15.l)

comp15 <- spread(comp15.l, Major.Category, sum.Area)
comp15$Pop <- NULL
comp15$Year <- 2015

colnames(comp15)[which(colnames(comp15) == "pCCA")] <- "CCA"
colnames(comp15)[which(colnames(comp15) == "pCoral")] <- "HardCoral"
colnames(comp15)[which(colnames(comp15) == "pInv")] <- "Invert"
colnames(comp15)[which(colnames(comp15) == "pMA")] <- "Macroalgae"
colnames(comp15)[which(colnames(comp15) == "pSoft")] <- "SoftCoral"
colnames(comp15)[which(colnames(comp15) == "pSubSa")] <- "Substrate.Sand"
colnames(comp15)[which(colnames(comp15) == "pTurCy")] <- "Turf"
head(comp15)

comp17 <- read.csv("data/TL2017-benthiccomp-transect.csv")
comp17$X <- NULL
head(comp17)

comp.2yr <- rbind(comp15, comp17)
nrow(comp15)
nrow(comp17)
nrow(comp.2yr)
head(comp.2yr)

comp.2yr$Year <- as.factor(comp.2yr$Year)
```

```{r}
#write.csv(comp.2yr, 'data/bencomp-transect-20152017.csv')

# add unique transect ids
library(tidyr)
library(dplyr)
comp.2yr$long_id <- as.factor(paste(comp.2yr$Site, comp.2yr$Depth, comp.2yr$Transect, sep = "_"))

ids <- read.csv("data/unique_ids_wnum_manatutu.csv")

comp.2yr <- comp.2yr %>% 
   inner_join( ids, by = 'long_id') %>% 
   select(Year, Site2, Site, Depth, Transect, num_id, CCA:Turf)

comp.2yr$long_id <- NULL

## summarized by coral site depth year
coral.ave <- comp.2yr %>% 
   group_by(Site2, Depth, Year) %>% 
   dplyr::summarize(corave = mean(HardCoral),
             corSE = sd(HardCoral)/sqrt(n()))
```
```{r coral repeated anova}
hist(comp.2yr$HardCoral)
qqnorm(comp.2yr$HardCoral)
qqline(comp.2yr$HardCoral)

hist(sqrt(comp.2yr$HardCoral))
qqnorm(sqrt(comp.2yr$HardCoral))
qqline(sqrt(comp.2yr$HardCoral))

hist(log10(comp.2yr$HardCoral))  # worse...
qqnorm(log10(comp.2yr$HardCoral))
qqline(log10(comp.2yr$HardCoral))

an.coral <- aov(HardCoral ~ Site * Depth * Transect + Year, data = comp.2yr)
plot(an.coral)
summary(an.coral)

an.sqrt.coral <-  aov(sqrt(HardCoral) ~ Site * Depth + Year, data = comp.2yr)
plot(an.sqrt.coral)
summary(an.sqrt.coral)

an.sqrt.coral2 <-  aov(sqrt(HardCoral) ~ Site * Depth * Year, data = comp.2yr)
plot(an.sqrt.coral2)
summary(an.sqrt.coral2)
TukeyHSD(an.sqrt.coral2)

library(nlme)
cor.lme <- lme(sqrt(HardCoral) ~ Site2 * Depth * Year, random = ~1|num_id, data = comp.2yr, na.action = na.exclude)
cor.lme
summary(cor.lme)
plot(cor.lme)
library(car)
Anova(cor.lme)

library(emmeans)
tuk.cor <- emmeans(cor.lme, list(pairwise ~ Site2:Depth:Year), adjust = "tukey")
pair.cor <- as.data.frame(tuk.cor$`pairwise differences of Site2, Depth, Year`)
sig.pair.cor <- pair.cor[which(pair.cor$p.value < 0.05),]
sig.pair.cor
```
You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
